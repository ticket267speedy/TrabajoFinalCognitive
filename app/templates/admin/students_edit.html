{% extends "base.html" %}
{% block title %}Editar Estudiante{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white text-center">
          <h4 class="mb-0">Editar Estudiante</h4>
        </div>
        <div class="card-body">
          <form id="editStudentForm">
            <div class="form-group">
              <label for="firstName">Nombre</label>
              <input type="text" class="form-control" id="firstName" name="first_name" value="{{ student.first_name }}" required>
            </div>
            <div class="form-group">
              <label for="lastName">Apellido</label>
              <input type="text" class="form-control" id="lastName" name="last_name" value="{{ student.last_name }}" required>
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" name="email" value="{{ student.email }}">
            </div>
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="scholarship" name="is_scholarship_student" {% if student.is_scholarship_student %}checked{% endif %}>
              <label class="form-check-label" for="scholarship">Es Becario</label>
            </div>
            <div id="editMessage" class="mb-3"></div>
            <button type="submit" class="btn btn-success btn-block">Guardar Cambios</button>
            <a href="/admin/students" class="btn btn-secondary btn-block mt-2">Cancelar</a>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const studentId = '{{ student.id }}';
function authHeaders() {
  const token = localStorage.getItem('access_token');
  return {
    'Authorization': 'Bearer ' + token,
    'Content-Type': 'application/json'
  };
}
document.getElementById('editStudentForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const firstName = document.getElementById('firstName').value.trim();
  const lastName = document.getElementById('lastName').value.trim();
  const email = document.getElementById('email').value.trim();
  const isScholarship = document.getElementById('scholarship').checked;
  try {
    const res = await fetch(`/api/admin/students/${studentId}`, {
      method: 'PUT',
      headers: authHeaders(),
      body: JSON.stringify({
        first_name: firstName,
        last_name: lastName,
        email: email,
        is_scholarship_student: isScholarship
      })
    });
    const data = await res.json();
    const msgDiv = document.getElementById('editMessage');
    if(res.ok) {
      msgDiv.innerHTML = '<div class="alert alert-success">Cambios guardados correctamente</div>';
      setTimeout(() => window.location.href = '/admin/students', 1500);
    } else {
      msgDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Error al guardar cambios'}</div>`;
    }
  } catch(e) {
    document.getElementById('editMessage').innerHTML = '<div class="alert alert-danger">Error de conexi√≥n</div>';
  }
});
</script>
{% endblock %}
