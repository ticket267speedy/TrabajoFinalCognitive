<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ingreso</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f6f8fa; margin: 0; }
      .container { max-width: 420px; margin: 8vh auto; background: #fff; padding: 24px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
      h1 { font-size: 20px; margin: 0 0 16px; }
      label { display: block; font-size: 14px; margin: 12px 0 6px; }
      input { width: 100%; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 8px; font-size: 14px; }
      button { width: 100%; margin-top: 18px; padding: 10px 14px; border: 0; border-radius: 8px; background: #0969da; color: #fff; font-weight: 600; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: default; }
      .msg { margin-top: 12px; font-size: 14px; }
      .msg.error { color: #d1242f; }
      .msg.success { color: #1a7f37; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ingreso</h1>
      <form id="loginForm">
        <label for="email">Email</label>
        <input id="email" name="email" type="email" required placeholder="tu@correo.com" />

        <label for="password">Contraseña</label>
        <input id="password" name="password" type="password" required placeholder="••••••" />

        <button id="submitBtn" type="submit">Ingresar</button>
        <div id="message" class="msg" aria-live="polite"></div>
      </form>
      <div class="actions" style="margin-top: 12px; display: flex; justify-content: center; gap: 6px;">
        <span>¿Eres asesor y no tienes cuenta?</span>
        <a href="/register" id="registerLink">Regístrate</a>
      </div>
    </div>

    <script>
      const form = document.getElementById('loginForm');
      const messageEl = document.getElementById('message');
      const submitBtn = document.getElementById('submitBtn');

      function setMessage(text, kind = 'error') {
        messageEl.textContent = text || '';
        messageEl.className = `msg ${kind}`;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setMessage('');

        const email = document.getElementById('email').value.trim().toLowerCase();
        const password = document.getElementById('password').value;

        if (!email || !password) {
          setMessage('Por favor ingresa email y contraseña.');
          return;
        }

        submitBtn.disabled = true;
        try {
          const res = await fetch('/api/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });

          const data = await res.json().catch(() => ({}));

          if (res.ok && data.access_token) {
            if (!data.user) {
              setMessage('Error en los datos del usuario.');
              return;
            }
            
            localStorage.setItem('access_token', data.access_token);
            setMessage('Ingreso exitoso. Redirigiendo…', 'success');
            
            // Redirigir según el rol del usuario
            if (data.user.role === 'admin') {
              // Ir al panel/dashboard del administrador
              window.location.href = '/admin/';
            } else if (data.user.role === 'advisor' || data.user.role === 'client') {
              window.location.href = '/dashboard';
            } else {
              setMessage('Rol de usuario no reconocido.');
              return;
            }
          } else {
            setMessage(data.error || 'Credenciales inválidas.');
          }
        } catch (err) {
          setMessage('Error de red. Intenta nuevamente.');
        } finally {
          submitBtn.disabled = false;
        }
      });
    </script>
  </body>
  </html>