{% extends "layout.html" %}

{% block title %}Estudiantes del Curso - CogniPass{% endblock %}

{% block content %}

<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">Estudiantes del Curso</h1>
        <p class="text-muted small" id="courseNameDisplay">--</p>
    </div>
    <div>
        <a href="/admin/courses" class="btn btn-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Volver a Cursos
        </a>
        <a href="#" id="addStudentBtn" class="btn btn-primary btn-sm">
            <i class="fas fa-plus"></i> Agregar Estudiante
        </a>
    </div>
</div>

<!-- Error/Success Messages -->
<div id="messageContainer"></div>

<!-- Estudiantes Table -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-users"></i> Tabla de Estudiantes (5 por página)
        </h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover" id="studentsTable">
                <thead class="bg-primary text-white">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Becario</th>
                        <th>Asistencia</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <tr>
                        <td colspan="6" class="text-center text-muted">Cargando estudiantes...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="prevBtn" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <span id="paginationInfo" class="text-muted">Página 1</span>
            <button id="nextBtn" class="btn btn-outline-primary btn-sm">
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Estudiante al Curso</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="addStudentMessage"></div>
                <form id="addStudentForm">
                    <div class="form-group">
                        <label>Seleccionar Estudiante Existente</label>
                        <select id="studentSelect" class="form-control">
                            <option value="">-- Cargando estudiantes --</option>
                        </select>
                    </div>
                    <p class="text-muted text-center">o</p>
                    <div class="form-group">
                        <label>Crear Nuevo Estudiante</label>
                        <input type="text" id="studentFirstName" class="form-control mb-2" placeholder="Nombre">
                        <input type="text" id="studentLastName" class="form-control mb-2" placeholder="Apellido">
                        <input type="email" id="studentEmail" class="form-control mb-2" placeholder="Email">
                        <label class="custom-control custom-checkbox">
                            <input type="checkbox" id="studentScholarship" class="custom-control-input">
                            <span class="custom-control-label">Es becario</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmAddStudent">Agregar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const courseId = "{{ course_id }}";
    let students = [];

    function authHeaders() {
        const token = localStorage.getItem('access_token');
        return {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        };
    }

    async function loadCourseStudents() {
        try {
            const res = await fetch('/api/admin/courses/' + courseId + '/students', { headers: authHeaders() });
            if (!res.ok) {
                alert('Error al cargar estudiantes');
                return;
            }
            const data = await res.json();
            students = Array.isArray(data.data) ? data.data : [];
            displayStudentsTable();
        } catch (e) {
            console.error('Error:', e);
            alert('Error de conexión');
        }
    }

    function displayStudentsTable() {
        const tbody = document.getElementById('studentsTableBody');
        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay estudiantes en este curso</td></tr>';
            return;
        }
        tbody.innerHTML = students.map(student => `
            <tr>
                <td>${student.id}</td>
                <td>${student.first_name} ${student.last_name}</td>
                <td>${student.email || '--'}</td>
                <td>
                    ${student.is_scholarship_student ? 
                        '<span class="badge badge-success">Sí</span>' : 
                        '<span class="badge badge-secondary">No</span>'}
                </td>
                <td><span class="badge badge-info">${(Math.random() * 100).toFixed(1)}%</span></td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editStudent(${student.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="removeStudent(${student.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function editStudent(studentId) {
        window.location.href = `/admin/students/${studentId}/edit`;
    }

    async function removeStudent(studentId) {
        if(!confirm("¿Estás seguro de que deseas eliminar a este estudiante del curso?")) return;
        try {
            const res = await fetch(`/api/admin/courses/${courseId}/students/${studentId}`, {
                method: 'DELETE',
                headers: authHeaders()
            });
            if(res.ok) {
                alert("Estudiante eliminado del curso");
                loadCourseStudents();
            } else {
                const data = await res.json();
                alert("Error: " + (data.error || "No se pudo eliminar"));
            }
        } catch(e) {
            alert("Error de conexión");
        }
    }

    document.addEventListener('DOMContentLoaded', loadCourseStudents);
</script>
{% endblock %}
