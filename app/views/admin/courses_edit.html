{% extends "layout.html" %}

{% block title %}Editar Curso - CogniPass{% endblock %}

{% block content %}

<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-4 text-gray-800">Editar Curso</h1>
        
        <!-- Error Messages -->
        <div id="messageContainer"></div>

        <!-- Course Form -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form id="courseForm">
                    <div class="form-group">
                        <label for="courseName">Nombre del Curso</label>
                        <input type="text" class="form-control" id="courseName" name="name" required 
                               placeholder="Ej: Matem치ticas Avanzadas">
                    </div>

                    <div class="form-group">
                        <label for="courseAdmin">Profesor Asignado</label>
                        <select class="form-control" id="courseAdmin" name="admin_id" required>
                            <option value="">-- Seleccionar profesor --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                        <a href="/admin/courses" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let ADMIN_API_PREFIX = '/api/admin';
    // Extract course_id from URL query parameters or path
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('course_id') || '{{ course_id }}';

    function authHeaders() {
        const token = localStorage.getItem('access_token');
        return {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };
    }

    function showMessage(message, type = 'success') {
        const container = document.getElementById('messageContainer');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="close" data-dismiss="alert">&times;</button>
        `;
        container.innerHTML = '';
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }

    async function detectAdminApiPrefix() {
        const prefixes = ['/api/admin', '/admin/api'];
        for (const prefix of prefixes) {
            try {
                const res = await fetch(`${prefix}/profile`, { headers: authHeaders() });
                if (res.ok) {
                    ADMIN_API_PREFIX = prefix;
                    return;
                }
            } catch (e) { }
        }
    }

    async function loadCourseData() {
        try {
            await detectAdminApiPrefix();
            const res = await fetch(`${ADMIN_API_PREFIX}/courses/${courseId}`, { headers: authHeaders() });
            
            if (!res.ok) {
                showMessage('Error al cargar el curso', 'danger');
                return;
            }

            const course = await res.json();
            document.getElementById('courseName').value = course.name;
            document.getElementById('courseAdmin').value = course.admin_id;
        } catch (e) {
            console.error('Error:', e);
            showMessage('Error de conexi칩n', 'danger');
        }
    }

    async function loadAdmins() {
        try {
            const res = await fetch(`${ADMIN_API_PREFIX}/users?role=admin`, { headers: authHeaders() });
            
            if (!res.ok) {
                showMessage('Error al cargar profesores', 'danger');
                return;
            }

            const users = await res.json();
            const adminSelect = document.getElementById('courseAdmin');
            const admins = Array.isArray(users) ? users : users.data || [];
            
            admins.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.id;
                option.textContent = `${admin.first_name || ''} ${admin.last_name || ''} (${admin.email})`;
                adminSelect.appendChild(option);
            });

            // Load course data after admins are loaded
            loadCourseData();
        } catch (e) {
            console.error('Error:', e);
            showMessage('Error de conexi칩n', 'danger');
        }
    }

    document.getElementById('courseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            name: document.getElementById('courseName').value,
            admin_id: parseInt(document.getElementById('courseAdmin').value)
        };

        try {
            const res = await fetch(`${ADMIN_API_PREFIX}/courses/${courseId}`, {
                method: 'PUT',
                headers: authHeaders(),
                body: JSON.stringify(formData)
            });

            const data = await res.json();
            
            if (res.ok) {
                showMessage('Curso actualizado correctamente', 'success');
                setTimeout(() => {
                    window.location.href = "/admin/courses";
                }, 1500);
            } else {
                showMessage(data.error || 'Error al actualizar curso', 'danger');
            }
        } catch (e) {
            console.error('Error:', e);
            showMessage('Error de conexi칩n', 'danger');
        }
    });

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadAdmins);
</script>
{% endblock %}
