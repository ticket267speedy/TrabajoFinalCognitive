{% extends "layout.html" %}

{% block title %}Estudiantes - CogniPass{% endblock %}

{% block content %}

<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Estudiantes</h1>
    <button id="addStudentBtn" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
        <i class="fas fa-plus fa-sm text-white-50"></i> Agregar Estudiante
    </button>
</div>

<!-- Estudiantes Card -->
<div class="card shadow">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Lista de Estudiantes</h6>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="bg-light">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Tipo</th>
                        <th>Cursos</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <tr><td colspan="5" class="text-center text-muted py-3">Cargando...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-3">
            <ul class="pagination justify-content-center" id="studentsPaginationNav">
                <!-- Pagination buttons will be generated by JavaScript -->
            </ul>
        </nav>
    </div>
</div>

<!-- Modal: Agregar Estudiante -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addStudentTitle">Agregar Estudiante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nombres</label>
                        <input id="newStudentFirst" class="form-control" placeholder="Nombres" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Apellidos</label>
                        <input id="newStudentLast" class="form-control" placeholder="Apellidos" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Email</label>
                        <input id="newStudentEmail" class="form-control" placeholder="Email" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Tipo</label>
                        <select id="newStudentScholarship" class="form-select">
                            <option value="false">No becario</option>
                            <option value="true">Becario</option>
                        </select>
                    </div>
                </div>
                <div id="addStudentMsg" class="alert alert-info mt-3" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="addStudentSubmit" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Editar Estudiante -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStudentTitle">Editar Estudiante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nombres</label>
                        <input id="editStudentFirst" class="form-control" placeholder="Nombres" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Apellidos</label>
                        <input id="editStudentLast" class="form-control" placeholder="Apellidos" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Email</label>
                        <input id="editStudentEmail" class="form-control" placeholder="Email" />
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label">Tipo</label>
                        <select id="editStudentScholarship" class="form-select">
                            <option value="false">No becario</option>
                            <option value="true">Becario</option>
                        </select>
                    </div>
                </div>
                <div id="editStudentMsg" class="alert alert-info mt-3" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" id="editStudentSubmit" class="btn btn-primary">Guardar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const token = localStorage.getItem('access_token');
    let ADMIN_API_PREFIX = '/api/admin';
    let studentsState = { items: [], page: 1, pageSize: 5 };

    function authHeaders() {
        const h = { 'Content-Type': 'application/json' };
        if (token) h['Authorization'] = `Bearer ${token}`;
        return h;
    }

    async function detectAdminApiPrefix() {
        const candidates = ['/api/admin', '/admin/api'];
        for (const prefix of candidates) {
            try {
                const res = await fetch(`${prefix}/profile`, { headers: authHeaders(), cache: 'no-store' });
                if (res.ok || res.status === 401 || res.status === 422) {
                    ADMIN_API_PREFIX = prefix;
                    return true;
                }
            } catch (e) { }
        }
        return false;
    }

    async function loadStudents() {
        if (!token) {
            document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">Por favor inicia sesión</td></tr>`;
            return;
        }

        const prefixes = ['/api/admin', '/admin/api'];
        let lastError = 'Error al cargar estudiantes';

        for (const p of prefixes) {
            try {
                const res = await fetch(`${p}/students`, { headers: authHeaders(), cache: 'no-store' });
                const data = await res.json().catch(() => ({}));

                if (res.status === 401 || res.status === 422) {
                    document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">No autorizado. Inicia sesión</td></tr>`;
                    return;
                }

                if (res.ok) {
                    const items = Array.isArray(data.items) ? data.items : (Array.isArray(data.data) ? data.data : (Array.isArray(data) ? data : []));
                    ADMIN_API_PREFIX = p;
                    studentsState.items = items;
                    studentsState.page = 1;
                    renderStudentsTable();
                    renderPagination();
                    return;
                }
                lastError = data.error || lastError;
            } catch (e) {
                lastError = e?.message || lastError;
            }
        }
        document.getElementById('studentsTableBody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">${lastError}</td></tr>`;
    }

    function renderStudentsTable() {
        const tbody = document.getElementById('studentsTableBody');
        const start = (studentsState.page - 1) * studentsState.pageSize;
        const end = start + studentsState.pageSize;
        const pageItems = studentsState.items.slice(start, end);

        if (pageItems.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">No hay estudiantes</td></tr>`;
            return;
        }

        tbody.innerHTML = pageItems.map(s => `
            <tr>
                <td>${s.id}</td>
                <td>${s.first_name} ${s.last_name}</td>
                <td>${s.email || '-'}</td>
                <td><span class="badge badge-${s.is_scholarship_student ? 'success' : 'secondary'}">
                    ${s.is_scholarship_student ? 'Becario' : 'Regular'}
                </span></td>
                <td>
                    ${s.courses && s.courses.length > 0 
                        ? s.courses.map(c => `<span class="badge badge-info">${c}</span>`).join(' ')
                        : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary edit-student-btn" data-id="${s.id}">Editar</button>
                    <button class="btn btn-sm btn-outline-danger delete-student-btn" data-id="${s.id}">Eliminar</button>
                </td>
            </tr>
        `).join('');
    }

    function renderPagination() {
        const nav = document.getElementById('studentsPaginationNav');
        const totalPages = Math.max(1, Math.ceil(studentsState.items.length / studentsState.pageSize));
        nav.innerHTML = '';

        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${studentsState.page <= 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" data-page="prev">Anterior</a>`;
        nav.appendChild(prevLi);

        // Page numbers
        const maxToShow = 6;
        let start = Math.max(1, studentsState.page - 2);
        let end = Math.min(totalPages, start + maxToShow - 1);
        if (end - start + 1 < maxToShow) {
            start = Math.max(1, end - maxToShow + 1);
        }

        for (let p = start; p <= end; p++) {
            const li = document.createElement('li');
            li.className = `page-item ${p === studentsState.page ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${p}">${p}</a>`;
            nav.appendChild(li);
        }

        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${studentsState.page >= totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" data-page="next">Siguiente</a>`;
        nav.appendChild(nextLi);

        // Add event listeners
        nav.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = link.dataset.page;
                if (page === 'prev' && studentsState.page > 1) {
                    studentsState.page--;
                } else if (page === 'next' && studentsState.page < totalPages) {
                    studentsState.page++;
                } else if (Number.isFinite(Number(page))) {
                    studentsState.page = Number(page);
                }
                renderStudentsTable();
                renderPagination();
            });
        });
    }

    // Add Student Modal
    document.getElementById('addStudentBtn').addEventListener('click', () => {
        document.getElementById('newStudentFirst').value = '';
        document.getElementById('newStudentLast').value = '';
        document.getElementById('newStudentEmail').value = '';
        document.getElementById('newStudentScholarship').value = 'false';
        document.getElementById('addStudentMsg').style.display = 'none';
        const modal = new bootstrap.Modal(document.getElementById('addStudentModal'));
        modal.show();
    });

    document.getElementById('addStudentSubmit').addEventListener('click', async () => {
        const payload = {
            first_name: document.getElementById('newStudentFirst').value.trim(),
            last_name: document.getElementById('newStudentLast').value.trim(),
            email: document.getElementById('newStudentEmail').value.trim() || null,
            is_scholarship_student: document.getElementById('newStudentScholarship').value === 'true'
        };

        const prefixes = ['/api/admin', '/admin/api'];
        let res = null, data = null;

        for (const p of prefixes) {
            try {
                res = await fetch(`${p}/students`, { method: 'POST', headers: authHeaders(), body: JSON.stringify(payload) });
                data = await res.json().catch(() => ({}));
                if (res.ok) {
                    ADMIN_API_PREFIX = p;
                    const msgEl = document.getElementById('addStudentMsg');
                    msgEl.style.display = 'block';
                    msgEl.textContent = 'Estudiante agregado exitosamente';
                    msgEl.className = 'alert alert-success mt-3';
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                        loadStudents();
                    }, 800);
                    return;
                }
            } catch (e) { }
        }

        const msgEl = document.getElementById('addStudentMsg');
        msgEl.style.display = 'block';
        msgEl.textContent = (data && data.error) || 'Error al agregar estudiante';
        msgEl.className = 'alert alert-danger mt-3';
    });

    // Edit Student
    document.getElementById('studentsTableBody').addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-student-btn');
        const deleteBtn = e.target.closest('.delete-student-btn');

        if (editBtn) {
            const id = editBtn.dataset.id;
            const student = studentsState.items.find(s => s.id == id);
            if (!student) return;

            document.getElementById('editStudentFirst').value = student.first_name || '';
            document.getElementById('editStudentLast').value = student.last_name || '';
            document.getElementById('editStudentEmail').value = student.email || '';
            document.getElementById('editStudentScholarship').value = student.is_scholarship_student ? 'true' : 'false';
            document.getElementById('editStudentMsg').style.display = 'none';
            window.currentEditStudentId = id;

            const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            modal.show();
        }

        if (deleteBtn) {
            const id = deleteBtn.dataset.id;
            if (!confirm('¿Estás seguro de que deseas eliminar este estudiante?')) return;

            const prefixes = ['/api/admin', '/admin/api'];
            for (const p of prefixes) {
                try {
                    const res = await fetch(`${p}/students/${id}`, { method: 'DELETE', headers: authHeaders() });
                    if (res.ok) {
                        ADMIN_API_PREFIX = p;
                        loadStudents();
                        return;
                    }
                } catch (e) { }
            }
            alert('Error al eliminar estudiante');
        }
    });

    document.getElementById('editStudentSubmit').addEventListener('click', async () => {
        const id = window.currentEditStudentId;
        const payload = {
            first_name: document.getElementById('editStudentFirst').value.trim(),
            last_name: document.getElementById('editStudentLast').value.trim(),
            email: document.getElementById('editStudentEmail').value.trim() || null,
            is_scholarship_student: document.getElementById('editStudentScholarship').value === 'true'
        };

        const prefixes = ['/api/admin', '/admin/api'];
        for (const p of prefixes) {
            try {
                const res = await fetch(`${p}/students/${id}`, { method: 'PATCH', headers: authHeaders(), body: JSON.stringify(payload) });
                const data = await res.json().catch(() => ({}));
                if (res.ok) {
                    ADMIN_API_PREFIX = p;
                    const msgEl = document.getElementById('editStudentMsg');
                    msgEl.style.display = 'block';
                    msgEl.textContent = 'Estudiante actualizado exitosamente';
                    msgEl.className = 'alert alert-success mt-3';
                    setTimeout(() => {
                        bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
                        loadStudents();
                    }, 800);
                    return;
                }
                const msgEl = document.getElementById('editStudentMsg');
                msgEl.style.display = 'block';
                msgEl.textContent = data.error || 'Error al actualizar';
                msgEl.className = 'alert alert-danger mt-3';
            } catch (e) { }
        }
    });

    // Initial load
    detectAdminApiPrefix().then(() => {
        loadStudents();
    });
</script>
{% endblock %}
