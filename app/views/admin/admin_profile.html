<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil del Administrador</title>
    <style>
      :root { --bg:#f6f8fa; --card:#fff; --border:#d0d7de; --text:#24292f; --primary:#0969da; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
      header { display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:10px; padding:16px 20px; background: var(--card); border-bottom: 1px solid var(--border); }
      h1 { margin:0; font-size:20px; }
      main { max-width: 900px; margin: 20px auto; padding: 0 16px; }
      .card { background: var(--card); border:1px solid var(--border); border-radius:10px; padding:16px; }
      .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
      input, textarea { padding:8px 10px; border:1px solid var(--border); border-radius:8px; width:100%; }
      button { padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; }
      button.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
      .avatar { width:96px; height:96px; border-radius:50%; object-fit:cover; border:1px solid var(--border); }
      ul.list { list-style:none; padding:0; margin:0; }
      ul.list li { padding:8px 10px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px; }
      .msg { margin-top:8px; font-size:14px; }
      .muted { color:#57606a; font-size:12px; }
      @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <header>
      <h1>Perfil del Administrador</h1>
      <nav class="row">
        <a href="/admin" style="text-decoration:none"><button>Volver al panel</button></a>
        <button id="logoutBtn" class="primary">Cerrar sesión</button>
      </nav>
    </header>
    <main>
      <section class="card">
        <div class="row">
          <img id="profilePhotoPreview" class="avatar" alt="Foto de perfil" />
          <div style="flex:1; min-width:240px;">
            <label>Nombre</label>
            <input id="profileName" disabled />
            <label class="muted">Email</label>
            <input id="profileEmail" disabled />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div style="flex:1; min-width:240px;">
            <label>Descripción</label>
            <textarea id="profileDescription" rows="4" maxlength="1000" placeholder="Tu descripción..."></textarea>
            <div class="muted" style="margin-top:4px;">
              <span id="charCount">0</span>/1000 caracteres
            </div>
            <div class="row" style="margin-top:8px;">
              <button id="saveProfile" class="primary">Guardar</button>
              <span id="profileMsg" class="msg"></span>
            </div>
          </div>
          <div style="min-width:240px;">
            <label>Actualizar foto</label>
            <input type="file" id="profilePhoto" accept="image/*" />
            <button id="uploadPhoto">Subir</button>
            <div id="photoMsg" class="msg"></div>
          </div>
        </div>
      </section>

      <section class="card" style="margin-top:16px;">
        <header class="row"><h2 style="margin:0; font-size:16px;">Cursos que dicta</h2></header>
        <ul id="profileCourses" class="list"></ul>
      </section>
    </main>

    <script>
      const token = localStorage.getItem('access_token');
      function authHeadersJSON() { const h = { 'Content-Type': 'application/json' }; if (token) h['Authorization'] = `Bearer ${token}`; return h; }
      function authHeadersForm() { const h = {}; if (token) h['Authorization'] = `Bearer ${token}`; return h; }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('access_token');
        window.location.href = '/login';
      });

      function updateCharCount() {
        const textarea = document.getElementById('profileDescription');
        const charCount = document.getElementById('charCount');
        charCount.textContent = textarea.value.length;
      }

      async function loadProfile() {
        const res = await fetch('/admin/api/profile', { headers: authHeadersJSON(), cache: 'no-store' });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById('profileMsg').textContent = data.error || 'Error al cargar perfil';
          return;
        }
        document.getElementById('profileName').value = `${data.first_name || ''} ${data.last_name || ''}`.trim();
        document.getElementById('profileEmail').value = data.email || '';
        document.getElementById('profileDescription').value = data.description || '';
        document.getElementById('profilePhotoPreview').src = data.profile_photo_url || '';
        updateCharCount(); // Actualizar contador después de cargar
        const ul = document.getElementById('profileCourses');
        ul.innerHTML = '';
        (data.courses || []).forEach(c => {
          const li = document.createElement('li');
          li.innerHTML = `<strong>${c.name}</strong> <span class="muted">(id: ${c.id})</span>`;
          ul.appendChild(li);
        });
      }

      document.getElementById('saveProfile').addEventListener('click', async () => {
        const desc = document.getElementById('profileDescription').value;
        const res = await fetch('/admin/api/profile', { method: 'PATCH', headers: authHeadersJSON(), body: JSON.stringify({ description: desc }) });
        const data = await res.json();
        document.getElementById('profileMsg').textContent = res.ok ? 'Perfil actualizado' : (data.error || 'Error');
      });

      document.getElementById('uploadPhoto').addEventListener('click', async () => {
        const fileInput = document.getElementById('profilePhoto');
        if (!fileInput.files || !fileInput.files[0]) return;
        const fd = new FormData();
        fd.append('photo', fileInput.files[0]);
        const res = await fetch('/admin/api/profile/photo', { method: 'POST', headers: authHeadersForm(), body: fd });
        const data = await res.json();
        document.getElementById('photoMsg').textContent = res.ok ? 'Foto actualizada' : (data.error || 'Error');
        if (res.ok) document.getElementById('profilePhotoPreview').src = data.profile_photo_url || '';
      });

      // Event listener para actualizar contador de caracteres en tiempo real
      document.getElementById('profileDescription').addEventListener('input', updateCharCount);

      loadProfile();
    </script>
  </body>
</html>