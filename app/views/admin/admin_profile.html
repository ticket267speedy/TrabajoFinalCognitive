<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Perfil del Administrador</title>
    <!-- KaiAdmin / Bootstrap CSS -->
    <link rel="stylesheet" href="/kaiadmin/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/kaiadmin/css/plugins.min.css" />
    <link rel="stylesheet" href="/kaiadmin/css/kaiadmin.min.css" />
    <link rel="stylesheet" href="/kaiadmin/css/fonts.min.css" />
  </head>
  <body class="bg-light">
    <!-- Navbar superior -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom shadow-sm">
      <div class="container-fluid">
        <span class="navbar-brand fw-semibold">Perfil del Administrador</span>
        <div class="ms-auto d-flex gap-2">
          <a href="/admin" class="btn btn-outline-secondary">Volver al panel</a>
          <button id="logoutBtn" class="btn btn-primary">Cerrar sesión</button>
        </div>
      </div>
    </nav>

    <main class="container-fluid py-4">
      <!-- Tarjeta de perfil -->
      <section class="card">
        <div class="card-body">
          <div class="row g-3 align-items-center">
            <div class="col-auto">
              <img id="profilePhotoPreview" class="rounded-circle border" alt="Foto de perfil" style="width:96px;height:96px;object-fit:cover;" />
            </div>
            <div class="col-md-6">
              <div class="mb-2">
                <label class="form-label">Nombre</label>
                <input id="profileName" class="form-control" disabled />
              </div>
              <div>
                <label class="form-label">Email</label>
                <input id="profileEmail" class="form-control" disabled />
              </div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-8">
              <label class="form-label">Descripción</label>
              <textarea id="profileDescription" class="form-control" rows="4" maxlength="1000" placeholder="Tu descripción..."></textarea>
              <small class="text-muted d-block mt-1"><span id="charCount">0</span>/1000 caracteres</small>
              <div class="mt-2 d-flex align-items-center gap-2">
                <button id="saveProfile" class="btn btn-primary">Guardar</button>
                <span id="profileMsg" class="text-muted"></span>
              </div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Actualizar foto</label>
              <input type="file" id="profilePhoto" class="form-control" accept="image/*" />
              <button id="uploadPhoto" class="btn btn-outline-primary mt-2">Subir</button>
              <div id="photoMsg" class="mt-2 text-muted"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tarjeta de cursos -->
      <section class="card mt-4">
        <div class="card-header">
          <h2 class="h6 m-0">Cursos que dicta</h2>
        </div>
        <div class="card-body">
          <ul id="profileCourses" class="list-group"></ul>
        </div>
      </section>
    </main>

    <script>
      const token = localStorage.getItem('access_token');
      function authHeadersJSON() { const h = { 'Content-Type': 'application/json' }; if (token) h['Authorization'] = `Bearer ${token}`; return h; }
      function authHeadersForm() { const h = {}; if (token) h['Authorization'] = `Bearer ${token}`; return h; }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('access_token');
        window.location.href = '/login';
      });

      function updateCharCount() {
        const textarea = document.getElementById('profileDescription');
        const charCount = document.getElementById('charCount');
        charCount.textContent = textarea.value.length;
      }

      async function loadProfile() {
        const res = await fetch('/admin/api/profile', { headers: authHeadersJSON(), cache: 'no-store' });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById('profileMsg').textContent = data.error || 'Error al cargar perfil';
          return;
        }
        document.getElementById('profileName').value = `${data.first_name || ''} ${data.last_name || ''}`.trim();
        document.getElementById('profileEmail').value = data.email || '';
        document.getElementById('profileDescription').value = data.description || '';
        document.getElementById('profilePhotoPreview').src = data.profile_photo_url || '';
        updateCharCount(); // Actualizar contador después de cargar
        const ul = document.getElementById('profileCourses');
        ul.innerHTML = '';
        (data.courses || []).forEach(c => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<span><strong>${c.name}</strong></span><span class="badge bg-secondary">id: ${c.id}</span>`;
          ul.appendChild(li);
        });
      }

      document.getElementById('saveProfile').addEventListener('click', async () => {
        const desc = document.getElementById('profileDescription').value;
        const res = await fetch('/admin/api/profile', { method: 'PATCH', headers: authHeadersJSON(), body: JSON.stringify({ description: desc }) });
        const data = await res.json();
        document.getElementById('profileMsg').textContent = res.ok ? 'Perfil actualizado' : (data.error || 'Error');
      });

      document.getElementById('uploadPhoto').addEventListener('click', async () => {
        const fileInput = document.getElementById('profilePhoto');
        if (!fileInput.files || !fileInput.files[0]) return;
        const fd = new FormData();
        fd.append('photo', fileInput.files[0]);
        const res = await fetch('/admin/api/profile/photo', { method: 'POST', headers: authHeadersForm(), body: fd });
        const data = await res.json();
        document.getElementById('photoMsg').textContent = res.ok ? 'Foto actualizada' : (data.error || 'Error');
        if (res.ok) document.getElementById('profilePhotoPreview').src = data.profile_photo_url || '';
      });

      // Event listener para actualizar contador de caracteres en tiempo real
      document.getElementById('profileDescription').addEventListener('input', updateCharCount);

      loadProfile();
    </script>
    <!-- KaiAdmin / Bootstrap JS -->
    <script src="/kaiadmin/js/core/jquery-3.7.1.min.js"></script>
    <script src="/kaiadmin/js/core/popper.min.js"></script>
    <script src="/kaiadmin/js/core/bootstrap.min.js"></script>
    <script src="/kaiadmin/js/kaiadmin.min.js"></script>
  </body>
</html>