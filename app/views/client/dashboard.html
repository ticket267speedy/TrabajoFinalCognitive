{% extends 'client/layout.html' %}
{% block title %}Dashboard Cliente{% endblock %}
{% block header_title %}Dashboard{% endblock %}
{% block content %}
  <div class="container-fluid">
    <!-- Tarjetas de estado -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-3">
        <div class="card status-card border-blue">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-bold">Informaci√≥n general</div>
                <div class="small text-muted">Cursos activos</div>
              </div>
              <span class="badge bg-blue">Activo</span>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card status-card border-green">
          <div class="card-body">
            <div class="fw-bold">Presentes</div>
            <div class="progress mt-2" role="progressbar" aria-label="Presencia">
              <div class="progress-bar bg-green" style="width: 72%">72%</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card status-card border-red">
          <div class="card-body">
            <div class="fw-bold">Ausencias</div>
            <div class="progress mt-2" role="progressbar" aria-label="Ausencias">
              <div class="progress-bar bg-red" style="width: 12%">12%</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <div class="card status-card border-yellow">
          <div class="card-body">
            <div class="fw-bold">Observaciones</div>
            <div class="progress mt-2" role="progressbar" aria-label="Observaciones">
              <div class="progress-bar bg-yellow" style="width: 16%">16%</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Asistencia diaria -->
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-calendar3"></i>
        <strong>Asistencia diaria</strong>
      </div>
      <div class="card-body">
        <div id="dailyAttendance" class="row g-3"></div>
      </div>
    </div>

    <!-- Tendencias -->
    <div class="card mb-3">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-graph-up"></i>
        <strong>Tendencias</strong>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <div class="small text-muted">Comparativo por curso (barra horizontal)</div>
            <div class="progress my-2" style="height: 20px">
              <div class="progress-bar bg-blue" style="width: 60%">Curso A 60%</div>
            </div>
            <div class="progress my-2" style="height: 20px">
              <div class="progress-bar bg-green" style="width: 80%">Curso B 80%</div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="small text-muted">Alertas recientes</div>
            <ul id="alertsList" class="list-group"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem('access_token');
    const authHeaders = token ? { Authorization: `Bearer ${token}` } : {};

    async function loadChildren() {
      const res = await fetch('/api/client/children', { headers: authHeaders });
      const data = await res.json();
      const container = document.getElementById('dailyAttendance');
      container.innerHTML = '';
      if (!res.ok) return;
      const today = new Date();
      const dmy = `${today.getDate().toString().padStart(2,'0')}/${(today.getMonth()+1).toString().padStart(2,'0')}`;
      for (const s of (data.items || [])) {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-4';
        col.innerHTML = `
          <div class="card h-100 border-gray">
            <div class="card-body d-flex align-items-center gap-3">
              <div class="avatar-circle bg-secondary text-white">${(s.first_name[0]||'')}${(s.last_name[0]||'')}</div>
              <div>
                <div class="fw-bold">${s.first_name} ${s.last_name}</div>
                <div class="small text-muted">${dmy}</div>
              </div>
              <span class="ms-auto badge badge-present">Presente</span>
            </div>
          </div>
        `;
        container.appendChild(col);
      }
    }

    async function loadAlerts() {
      const res = await fetch('/api/client/alerts', { headers: authHeaders });
      const data = await res.json();
      const list = document.getElementById('alertsList');
      list.innerHTML = '';
      if (!res.ok) return;
      for (const a of (data.items || [])) {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex align-items-center justify-content-between';
        const dt = a.created_at ? new Date(a.created_at) : null;
        const dmy = dt ? `${dt.getDate().toString().padStart(2,'0')}/${(dt.getMonth()+1).toString().padStart(2,'0')}` : '';
        li.innerHTML = `
          <div>
            <div class="fw-bold">${a.course_name || 'Curso'}</div>
            <div class="small">${a.message}</div>
          </div>
          <span class="badge badge-warning">${dmy}</span>
        `;
        list.appendChild(li);
      }
    }

    loadChildren();
    loadAlerts();
  </script>
{% endblock %}